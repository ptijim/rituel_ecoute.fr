<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Test — Auto-load liste_defaut.xlsx</title>

  <!-- Tailwind (just for basic styling, optional) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .card { border: 1px solid #e5e7eb; border-radius: 0.75rem; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .badge { display:inline-block; padding: .125rem .5rem; border:1px solid #e5e7eb; border-radius: 9999px; background:#f8fafc; font-size:.75rem; }
  </style>

  <script>
    // --- Small helpers ---
    const pad = n => String(n).padStart(2, "0");
    function excelSerialToISO(n){
      if (typeof n !== "number" || !isFinite(n)) return "";
      const epoch = new Date(1899,11,30);
      const ms = epoch.getTime() + Math.round(n)*86400000;
      const d = new Date(ms);
      return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
    }
    function toISODate(v){
      if (v===null || v===undefined) return "";
      if (typeof v === "number") return excelSerialToISO(v);
      const s = String(v).trim();
      let m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/); // JJ-MM-AAAA
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;
      m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/); // ISO
      if (m) return s;
      const d = new Date(s);
      if (!isNaN(+d)) return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
      return "";
    }
    const isISO = s => typeof s==="string" && /^\d{4}-\d{2}-\d{2}$/.test(s);

    async function loadXLSX(){
      const log = (msg, cls="text-slate-600") => {
        const el = document.getElementById("log");
        const p = document.createElement("div"); p.className = cls; p.textContent = msg; el.appendChild(p);
      };
      try{
        log("Chargement de liste_defaut.xlsx ...");
        const resp = await fetch("liste_defaut.xlsx?cb="+Date.now(), {cache:"no-store"});
        if(!resp.ok){ throw new Error("HTTP "+resp.status); }
        const buf = await resp.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        let rows = XLSX.utils.sheet_to_json(ws, {defval:""});
        log("Fichier lu, normalisation des colonnes ...");

        let skipped = 0;
        rows = rows.map(r => {
          const o = {...r};
          o.date = toISODate(o.date || o.Date || o.DATE);
          o.titre = o.titre || o.title || o.Title || o["Titre"] || "";
          o.auteur = o.auteur || o.author || o.Auteur || o["Auteur / Artiste"] || "";
          o.origin = (o.origin || o["origine (pays auteur)"] || o["Origine (pays auteur)"] || o.origine || o.Origine || "").toString().trim();
          o.youtube = o.youtube || o.YouTube || o["lien youtube"] || "";
          o.instruments = (o.instruments && String(o.instruments).toLowerCase()!=="nan") ? o.instruments : "";
          return o;
        }).filter(x => {
          const ok = isISO(x.date);
          if(!ok) skipped++;
          return ok;
        });
        log(`Lignes valides: ${rows.length} • Lignes ignorées (date invalide): ${skipped}`, "text-emerald-700");

        // Render simple table
        const body = document.getElementById("tbody");
        body.innerHTML = "";
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="px-3 py-2 text-sm">${r.date}</td>
            <td class="px-3 py-2">${r.titre}</td>
            <td class="px-3 py-2">${r.auteur}</td>
            <td class="px-3 py-2">${r.origin}</td>
            <td class="px-3 py-2 mono">${r.youtube}</td>
            <td class="px-3 py-2">${r.instruments}</td>
          `;
          body.appendChild(tr);
        }

        document.getElementById("count").textContent = rows.length;
        document.getElementById("okBadge").classList.remove("hidden");
      }catch(e){
        const el = document.getElementById("error");
        el.textContent = "Erreur: " + e.message + ". Vérifie que 'liste_defaut.xlsx' est dans le même dossier que cette page.";
        el.classList.remove("hidden");
        console.error(e);
      }
    }

    document.addEventListener("DOMContentLoaded", loadXLSX);
  </script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-4 md:p-6 space-y-4">
    <header class="flex items-end justify-between">
      <h1 class="text-2xl md:text-3xl font-black">Test — Auto-load <span class="badge">liste_defaut.xlsx</span></h1>
      <div id="okBadge" class="hidden badge">chargé</div>
    </header>

    <div id="error" class="hidden card p-3 text-sm text-red-700 bg-red-50 border border-red-200"></div>

    <div class="card p-4">
      <div id="log" class="text-sm space-y-1"></div>
    </div>

    <div class="card overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-100 border-b">
          <tr>
            <th class="px-3 py-2 text-left">date (ISO)</th>
            <th class="px-3 py-2 text-left">titre</th>
            <th class="px-3 py-2 text-left">auteur</th>
            <th class="px-3 py-2 text-left">origine</th>
            <th class="px-3 py-2 text-left">youtube</th>
            <th class="px-3 py-2 text-left">instruments</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="text-slate-600 text-sm">Total lignes affichées : <span id="count">0</span></div>
  </div>
</body>
</html>
